(()=>{if(console.log("üõ°Ô∏è Clarity AI: Pro Engine (Tuned for False Positives)"),["linkedin.com","github.com","facebook.com","twitter.com","x.com","instagram.com","tiktok.com","youtube.com","stackoverflow.com"].some(e=>window.location.hostname.includes(e)))throw new Error("Clarity AI stopped: Domain Blocked.");const e=["google.com","outlook","yahoo","office.com","office365.com"].some(e=>window.location.hostname.includes(e)),t=["mail","webmail","email","inbox","outlook","zimbra"].some(e=>window.location.href.includes(e));if(!e&&!t)throw new Error("Clarity AI stopped: Non-Email URL.");console.log("üöÄ Clarity X-Ray: ACTIVE");const o=[/urgent action/gi,/immediate action/gi,/account suspended/gi,/account deactivated/gi,/verify your identity/gi,/confirm your password/gi,/unusual sign-in/gi,/wire transfer/gi,/security alert/gi,/final notice/gi],n=new Set,r=new Set;function i(e){e.classList.add("clarity-locked"),e.querySelectorAll("a, button, input").forEach(e=>{e.style.filter="blur(5px)",e.style.pointerEvents="none"})}function c(e,t,o,i){if(document.getElementById("cl-alert"))return;const c=document.createElement("div");c.id="cl-alert",c.style.cssText="position:fixed; top:100px; right:20px; width:320px; background:white; padding:20px; border-radius:8px; box-shadow:0 10px 40px rgba(0,0,0,0.4); border-left:6px solid #c0392b; z-index:2147483647; font-family:sans-serif;",c.innerHTML=`\n    <h3 style="margin:0 0 10px 0; color:#c0392b;">‚ö†Ô∏è Threat Detected</h3>\n    <p style="font-size:13px; color:#555;">${o}</p>\n    <div style="font-size:12px; margin-bottom:10px; color:#777;">Risk Score: ${t}/10</div>\n    <button id="unl-btn" disabled style="width:100%; padding:10px; background:#ccc; border:none; border-radius:4px; color:white; font-weight:bold;">Wait 5s...</button>\n  `,document.body.appendChild(c);let l=5;const a=setInterval(()=>{l--;const t=document.getElementById("unl-btn");t&&(t.innerText=`Wait ${l}s...`),l<=0&&(clearInterval(a),t&&(t.disabled=!1,t.innerText="Unlock Links",t.style.background="#2c3e50",t.style.cursor="pointer",t.onclick=()=>{e.querySelectorAll("*").forEach(e=>{e.style.filter="",e.style.pointerEvents=""}),e.classList.remove("clarity-locked"),c.remove(),r.delete(i),n.add(i)}))},1e3)}setInterval(function(){const e=function(){const e=document.querySelector(".gD");if(e)return{sender:`${e.innerText} <${e.getAttribute("email")||""}>`,subject:document.querySelector("h2.hP")?.innerText||"No Subject",bodyContainer:document.querySelector(".a3s.aiL")||document.querySelector(".a3s"),platform:"Gmail"};if(document.querySelector(".ReadingPaneRoot")||document.querySelector('[aria-label="Message body"]')?.closest('[role="main"]')||document.querySelector('div[id*="O365"]')){const e=document.querySelectorAll('[data-test-id="persona-details"] span, .O3L68, span[title*="@"]');for(let t of e){const e=t.innerText,o=t.getAttribute("title")||"";if(e.includes("@")||o.includes("@"))return{sender:e.includes("@")?e:o,subject:document.querySelector('[data-test-id="full-view-subject"]')?.innerText||document.querySelector(".conv-title")?.innerText||"Subject",bodyContainer:document.querySelector('[aria-label="Message body"]')||document.querySelector(".ReadingPaneRoot")||document.body,platform:"Outlook"}}}const t=document.querySelectorAll(".sender, .from, .email-header");for(let e of t)if(e.innerText.includes("@")){const t=document.querySelector(".message-body, .msg-body, .body");if(t)return{sender:e.innerText,subject:document.title,bodyContainer:t,platform:"Webmail"}}return null}();if(!e||!e.bodyContainer)return;const{sender:t,subject:l,bodyContainer:a,platform:s}=e;if(a===document.body)return;const d=a.innerText,u=`${l}_${d.length}`;if(n.has(u))return void("none"!==a.style.filter&&(a.style.filter="none"));if(r.has(u))return void(a.classList.contains("clarity-locked")||(i(a),document.getElementById("cl-alert")||c(a,8,"Threat Detected",u)));if(a.classList.contains("clarity-scanning"))return;a.classList.add("clarity-scanning"),function(e){if(document.getElementById("cl-badge"))return;const t=document.createElement("div");t.id="cl-badge",t.innerText=`üõ°Ô∏è Clarity AI (${e})`,t.style.cssText="position:fixed; bottom:20px; right:20px; background:#f1c40f; color:#333; padding:8px 12px; border-radius:20px; font-weight:bold; z-index:99999; font-family:sans-serif; font-size:12px; box-shadow:0 2px 5px rgba(0,0,0,0.2);",document.body.appendChild(t)}(s);const m=function(e,t){const o=e.querySelectorAll("a").length,n=e.querySelectorAll("img").length;return t.replace(/\s/g,"").length<30&&n>0&&o>0?{isThreat:!0,reason:"Suspicious: Image-only email detected."}:{isThreat:!1}}(a,d),y=`From: ${t}\nSubject: ${l}\n\n${d}`,f=Array.from(a.querySelectorAll("a")).map(e=>e.href);chrome.runtime.sendMessage({action:"analyze_context",text:y,links:f},e=>{a.classList.remove("clarity-scanning"),document.getElementById("cl-badge")?.remove();const t=e&&e.isThreat&&e.score>7||m.isThreat,l=m.isThreat?m.reason:e?e.verdict:"",s=e?e.score:m.isThreat?9:0;t?(r.add(u),i(a),c(a,s,l,u),function(e){const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);let n;const r=[];for(;n=t.nextNode();)["SCRIPT","STYLE"].includes(n.parentNode.tagName)||o.some(e=>e.test(n.nodeValue))&&r.push(n);r.forEach(e=>{const t=document.createElement("span");t.innerHTML=e.nodeValue,o.forEach(e=>{t.innerHTML=t.innerHTML.replace(e,e=>`<span style="background:#fadbd8; border-bottom:2px solid #c0392b; color:#c0392b; font-weight:bold;">${e}</span>`)}),e.parentNode.replaceChild(t,e)})}(a)):n.add(u)})},1500)})();